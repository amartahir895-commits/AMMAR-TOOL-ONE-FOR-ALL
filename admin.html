<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professor Ammar Toolkit Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">

    <!-- Navbar -->
    <nav class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-2">
            <div class="bg-gradient-to-r from-pink-500 to-purple-600 text-white w-8 h-8 rounded-lg flex items-center justify-center font-bold">L</div>
            <span class="font-bold text-xl tracking-tight">Dashboard</span>
        </div>
        <div class="flex items-center gap-4">
            <a id="previewLink" href="#" target="_blank" class="text-sm text-indigo-600 hover:underline">View Public Page <i class="fas fa-external-link-alt ml-1"></i></a>
            <button onclick="logout()" class="text-gray-500 hover:text-red-500 transition"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8 max-w-4xl">
        
        <!-- Welcome Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Welcome, <span id="userDisplay" class="text-indigo-600">User</span></h1>
            <p class="text-gray-500">Manage your links and profile appearance.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            
            <!-- Profile Settings -->
            <div class="md:col-span-1 space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h2 class="font-bold text-lg mb-4">Profile Details</h2>
                    <form id="profileForm" class="space-y-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Page Title</label>
                            <input type="text" id="pageTitle" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-sm focus:border-indigo-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Description</label>
                            <textarea id="pageDesc" rows="3" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-sm focus:border-indigo-500 outline-none"></textarea>
                        </div>
                        <button type="submit" class="w-full bg-gray-900 text-white py-2 rounded text-sm hover:bg-gray-800 transition">Save Profile</button>
                    </form>
                </div>
            </div>

            <!-- Links Manager -->
            <div class="md:col-span-2 space-y-6">
                
                <!-- Add New Link -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h2 class="font-bold text-lg mb-4">Add New Tool/Link</h2>
                    <form id="addLinkForm" class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <input type="text" id="linkName" placeholder="Link Name (e.g. Instagram)" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-sm outline-none focus:border-indigo-500" required>
                            <input type="url" id="linkUrl" placeholder="URL (https://...)" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-sm outline-none focus:border-indigo-500" required>
                        </div>
                        
                        <div class="border-2 border-dashed border-gray-200 rounded-lg p-4 text-center hover:bg-gray-50 transition cursor-pointer relative">
                            <input type="file" id="linkImage" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                            <div class="text-gray-400 text-sm">
                                <i class="fas fa-cloud-upload-alt text-2xl mb-2"></i>
                                <p id="fileName">Click to upload icon (optional)</p>
                            </div>
                        </div>

                        <button type="submit" id="addBtn" class="w-full bg-indigo-600 text-white py-2.5 rounded shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition flex justify-center items-center gap-2">
                            <i class="fas fa-plus"></i> Add Link
                        </button>
                    </form>
                </div>

                <!-- Existing Links List -->
                <div id="linksList" class="space-y-3">
                    <!-- Links will be injected here via JS -->
                    <div class="text-center py-10 text-gray-400">Loading links...</div>
                </div>

            </div>
        </div>
    </div>

    <!-- Logic -->
    <script type="module">
        import { db, storage, doc, getDoc, updateDoc, arrayUnion, ref, uploadBytes, getDownloadURL } from './config.js';

        // Auth Check
        const user = sessionStorage.getItem('user');
        if (!user) window.location.href = 'index.html';

        document.getElementById('userDisplay').innerText = user;
        document.getElementById('previewLink').href = `view.html?page=${user}`;

        const docRef = doc(db, "pages", user);

        // Load Data
        async function loadData() {
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('pageTitle').value = data.title;
                document.getElementById('pageDesc').value = data.description;
                renderLinks(data.links || []);
            }
        }

        // Render Links
        function renderLinks(links) {
            const container = document.getElementById('linksList');
            container.innerHTML = '';

            if(links.length === 0) {
                container.innerHTML = '<div class="text-center py-4 text-gray-400">No links yet. Add one above!</div>';
                return;
            }

            links.forEach((link, index) => {
                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded-lg shadow-sm border border-gray-100 flex items-center justify-between group hover:border-indigo-300 transition';
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        ${link.image ? `<img src="${link.image}" class="w-10 h-10 rounded-full object-cover bg-gray-100">` : `<div class="w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center"><i class="fas fa-link"></i></div>`}
                        <div>
                            <h3 class="font-bold text-gray-800">${link.name}</h3>
                            <p class="text-xs text-gray-500 truncate max-w-[200px]">${link.url}</p>
                        </div>
                    </div>
                    <button onclick="deleteLink(${index})" class="text-gray-300 hover:text-red-500 p-2 transition"><i class="fas fa-trash"></i></button>
                `;
                container.appendChild(div);
            });
        }

        // Profile Update
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = "Saving...";
            
            await updateDoc(docRef, {
                title: document.getElementById('pageTitle').value,
                description: document.getElementById('pageDesc').value
            });
            
            btn.innerText = "Saved!";
            setTimeout(() => btn.innerText = originalText, 2000);
        });

        // File Input UX
        document.getElementById('linkImage').addEventListener('change', function() {
            if(this.files[0]) document.getElementById('fileName').innerText = this.files[0].name;
        });

        // Add Link
        document.getElementById('addLinkForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('addBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            btn.disabled = true;

            const name = document.getElementById('linkName').value;
            const url = document.getElementById('linkUrl').value;
            const file = document.getElementById('linkImage').files[0];
            let imageUrl = '';

            try {
                // 1. Upload Image if exists
                if (file) {
                    const storageRef = ref(storage, `images/${user}/${Date.now()}_${file.name}`);
                    await uploadBytes(storageRef, file);
                    imageUrl = await getDownloadURL(storageRef);
                }

                // 2. Update Firestore
                const newLink = { name, url, image: imageUrl };
                await updateDoc(docRef, {
                    links: arrayUnion(newLink)
                });

                // 3. Reset UI
                e.target.reset();
                document.getElementById('fileName').innerText = 'Click to upload icon (optional)';
                loadData(); // Reload list
            } catch (error) {
                console.error(error);
                alert("Error adding link");
            }

            btn.innerHTML = '<i class="fas fa-plus"></i> Add Link';
            btn.disabled = false;
        });

        // Delete Link Logic (Exposed to Window)
        window.deleteLink = async (index) => {
            if(!confirm('Delete this link?')) return;
            
            const docSnap = await getDoc(docRef);
            const links = docSnap.data().links;
            const linkToRemove = links[index];

            await updateDoc(docRef, {
                links: links.filter((_, i) => i !== index)
            });
            loadData();
        };

        // Logout
        window.logout = () => {
            sessionStorage.removeItem('user');
            window.location.href = 'index.html';
        };

        // Init
        loadData();
    </script>
</body>
</html>
